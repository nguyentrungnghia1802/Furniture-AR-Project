class d{constructor(e){this.modelViewer=e,this.isArSupported=!1,this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent),this.isAndroid=/Android/.test(navigator.userAgent),this.init()}async init(){await this.checkArSupport(),this.setupEventListeners(),this.updateArButton()}async checkArSupport(){if(this.modelViewer)try{if("xr"in navigator){const e=await navigator.xr.isSessionSupported("immersive-ar");this.isArSupported=e}else this.isIOS&&(this.isArSupported=!0)}catch(e){console.log("AR capability check failed:",e),this.isArSupported=!1}}setupEventListeners(){this.modelViewer&&(this.modelViewer.addEventListener("ar-status",e=>{this.handleArStatusChange(e.detail.status)}),this.modelViewer.addEventListener("load",()=>{this.onModelLoaded()}),this.modelViewer.addEventListener("error",e=>{this.onModelError(e)}),this.modelViewer.addEventListener("progress",e=>{this.updateLoadingProgress(e.detail.totalProgress)}))}handleArStatusChange(e){document.getElementById("ar-button");const t=document.getElementById("ar-status");switch(e){case"not-presenting":this.updateArButtonText("View in AR"),t&&(t.textContent="AR Ready");break;case"session-started":this.updateArButtonText("Exit AR"),t&&(t.textContent="AR Active"),this.trackArUsage("ar_session_started");break;case"object-placed":t&&(t.textContent="Object Placed"),this.trackArUsage("ar_object_placed");break;case"failed":this.updateArButtonText("AR Unavailable"),t&&(t.textContent="AR Failed");break}}updateArButtonText(e){const t=document.getElementById("ar-button");t&&(t.textContent=e)}updateArButton(){const e=document.getElementById("ar-button"),t=document.getElementById("ar-container");e&&t&&(this.isArSupported?(t.style.display="block",e.disabled=!1,e.classList.remove("opacity-50")):t.style.display="none")}onModelLoaded(){const e=document.getElementById("model-loading");e&&(e.style.display="none"),this.modelViewer.cameraControls=!0,this.trackArUsage("model_loaded")}onModelError(e){console.error("Model loading error:",e);const t=document.getElementById("model-error");t&&(t.style.display="block",t.textContent="Failed to load 3D model"),this.trackArUsage("model_error")}updateLoadingProgress(e){const t=document.getElementById("loading-progress");t&&(t.style.width=`${e*100}%`)}trackArUsage(e){fetch("/api/track-ar-usage",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({action:e,product_id:this.modelViewer.dataset.productId,timestamp:new Date().toISOString()})}).catch(t=>console.log("Analytics tracking failed:",t))}activateAr(){this.modelViewer&&this.isArSupported&&this.modelViewer.activateAR()}resetCamera(){this.modelViewer&&(this.modelViewer.resetTurntableRotation(),this.modelViewer.jumpCameraToGoal())}async takeScreenshot(){if(this.modelViewer)try{const e=await this.modelViewer.toBlob({idealAspect:!0,mimeType:"image/png"}),t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download=`${this.modelViewer.dataset.productName||"product"}-3d-view.png`,o.click(),URL.revokeObjectURL(t),this.trackArUsage("screenshot_taken")}catch(e){console.error("Screenshot failed:",e)}}}document.addEventListener("DOMContentLoaded",function(){const r=document.querySelectorAll("model-viewer[ar]"),e=[];r.forEach((n,a)=>{const s=new d(n);e.push(s),window[`arViewer${a}`]=s});const t=document.getElementById("ar-button");t&&e.length>0&&t.addEventListener("click",()=>{e[0].activateAr()});const o=document.getElementById("reset-camera");o&&e.length>0&&o.addEventListener("click",()=>{e[0].resetCamera()});const i=document.getElementById("screenshot-button");i&&e.length>0&&i.addEventListener("click",()=>{e[0].takeScreenshot()}),e.length>0&&(window.mainArViewer=e[0])});window.ArHelpers={showArInstructions(){const r=document.getElementById("ar-instructions-modal");r&&(r.style.display="block")},hideArInstructions(){const r=document.getElementById("ar-instructions-modal");r&&(r.style.display="none")},checkCompatibility(){const r=/iPad|iPhone|iPod/.test(navigator.userAgent),e=/Android/.test(navigator.userAgent);return r?'AR supported via QuickLook. Tap "View in AR" to place the furniture in your space.':e?"AR supported via WebXR. Make sure you have ARCore installed for the best experience.":"AR viewing requires a mobile device with AR support (iOS 12+ or Android with ARCore)."}};
